{% extends "base.html" %}

{% block title %}Cognitive Load | Study Skills AI{% endblock %}
{% block theme_class %}theme-green{% endblock %}

{% block content %}
<div class="filter-header">
    <a href="/" class="back-link">‚Üê Dashboard</a>
    <h1>üíö Cognitive Load Management</h1>
    <p>Break down complex topics into manageable chunks and simplify language.</p>
</div>

<div class="input-area">
    <div class="file-upload-area">
        <input type="file" id="file-input" hidden accept=".txt,.pdf">
        <span style="font-size: 3em;">üìÑ</span>
        <p><strong>Click or Drag to Upload PDF/Text</strong></p>
    </div>

    <textarea id="study-text" placeholder="Paste complex study material here..."></textarea>

    <button id="process-btn" class="btn btn-primary" style="width: 100%;">Simplify & Chunk</button>
</div>

<div id="loading" class="loading">
    <div class="spinner" style="border-top-color: var(--green);"></div>
    <p>Breaking down complexity...</p>
</div>

<div id="results" class="result-box"></div>

{% endblock %}

{% block extra_js %}
<script>
    setupFileUpload('file-input', 'study-text');

    document.getElementById('process-btn').addEventListener('click', async function () {
        const text = document.getElementById('study-text').value.trim();
        if (!text) { alert('Please provide some text first!'); return; }

        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const btn = this;

        loading.style.display = 'block';
        results.classList.remove('visible');
        btn.disabled = true;

        try {
            const response = await fetch('/apply_filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    filter: 'green'
                })
            });

            const data = await response.json();

            if (data.success) {
                renderGreenResults(data.result);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error: ' + e);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    });

    function renderGreenResults(result) {
        let html = `<h2>‚úÖ Management Plan</h2>`;

        html += `<h3>üß± Prerequisites</h3>`;
        html += `<ul>${result.prerequisites.map(p => `<li>${p}</li>`).join('')}</ul>`;

        html += `<h3>üß© Content Chunks</h3>`;
        result.chunks.forEach(chunk => {
            html += `
            <div style="background: white; border-left: 5px solid var(--green); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h4 style="color: var(--green); margin-bottom: 10px;">Step ${chunk.id}: ${chunk.main_idea}</h4>
                <p>${chunk.content}</p>
                <div style="margin-top: 10px; font-size: 0.85em; color: #888;">${chunk.word_count} words</div>
            </div>`;
        });

        html += `<h3>‚ú® Simplified Summary</h3>`;
        html += `<div style="background: #e8f8f5; padding: 20px; border-radius: 12px; line-height: 1.8;">${result.simplified_text}</div>`;

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('visible');
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}