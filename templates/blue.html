{% extends "base.html" %}

{% block title %}Metacognition | Study Skills AI{% endblock %}
{% block theme_class %}theme-blue{% endblock %}

{% block content %}
<div class="filter-header">
    <a href="/" class="back-link">‚Üê Dashboard</a>
    <h1>üìò Metacognition Filter</h1>
    <p>Generate Bloom's Taxonomy questions to deepen your understanding.</p>
</div>

<div class="input-area">
    <div class="file-upload-area">
        <input type="file" id="file-input" hidden accept=".txt,.pdf">
        <span style="font-size: 3em;">üìÑ</span>
        <p><strong>Click or Drag to Upload PDF/Text</strong></p>
        <p style="font-size: 0.9em; opacity: 0.7;">We'll extract the text for you.</p>
    </div>

    <textarea id="study-text" placeholder="Or paste your study material here..."></textarea>

    <button id="process-btn" class="btn btn-primary" style="width: 100%;">Generate Questions</button>
</div>

<div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Analyzing text with Gemini AI...</p>
</div>

<div id="results" class="result-box"></div>

{% endblock %}

{% block extra_js %}
<script>
    // Setup file upload
    setupFileUpload('file-input', 'study-text');

    document.getElementById('process-btn').addEventListener('click', async function () {
        const text = document.getElementById('study-text').value.trim();
        if (!text) { alert('Please provide some text first!'); return; }

        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const btn = this;

        loading.style.display = 'block';
        results.classList.remove('visible');
        btn.disabled = true;

        try {
            const response = await fetch('/apply_filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    filter: 'blue'
                })
            });

            const data = await response.json();

            if (data.success) {
                renderBlueResults(data.result);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error: ' + e);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    });

    function renderBlueResults(result) {
        let html = `<h2>Analysis Results</h2>`;
        html += `<p style="margin-bottom: 20px; font-style: italic;">${result.summary}</p>`;

        html += `<h3>üîë Key Concepts</h3>`;
        html += `<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px;">`;
        result.concepts.forEach(c => {
            html += `<span style="background: rgba(79, 172, 254, 0.2); color: #4facfe; padding: 5px 15px; border-radius: 20px; font-weight: bold;">${c}</span>`;
        });
        html += `</div>`;

        html += `<h3>üß† Bloom's Taxonomy Questions</h3>`;
        for (const [level, question] of Object.entries(result.questions)) {
            html += `
            <div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #4facfe;">
                <div style="color: #4facfe; font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">${level.toUpperCase()}</div>
                <div>${question}</div>
            </div>`;
        }

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('visible');
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}